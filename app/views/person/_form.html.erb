<script>
    (function($){
        $.fn.serializeHash = function() {
            var hash = {}

            function stringKey(key, value) {
                var beginBracket = key.lastIndexOf('[');
                if (beginBracket == -1) {
                    var hash = {};
                    hash[key] = value;
                    return hash;
                }
                var newKey = key.substr(0, beginBracket);
                var newValue = {};
                newValue[key.substring(beginBracket + 1, key.length - 1)] = value;
                return stringKey(newKey, newValue);
            }

            var els = $(this).find(':input').get();
            $.each(els, function() {
                if (this.name && !this.disabled && (this.checked || /select|textarea/i.test(this.nodeName) || /hidden|text|search|tel|url|email|password|datetime|date|month|week|time|datetime-local|number|range|color/i.test(this.type))) {
                    var val = $(this).val();
                    $.extend(true, hash, stringKey(this.name, val));
                }
            });
            return hash;
        };
    })(jQuery);
</script>

<link href="/Pikaday/css/pikaday.css" rel="stylesheet">


<style>
  label{
      margin-left: 20px;
      margin-right: 10px;
      min-width: 100px;
      text-align: left;
  }

  input, select{
      width: 200px;
      background: lightblue;
      font-weight: bold;
      padding: 5px;
      box-sizing: border-box;
      -moz-box-sizing: border-box;
      -webkit-box-sizing: border-box;
      -ms-box-sizing:content-box;
      -moz-box-sizing:content-box;
      -webkit-box-sizing:content-box;
      box-sizing:content-box;
  }

  .row{
      margin-bottom: 10px;
  }
  fieldset .form-error{
      display: none;
  }
    fieldset{
        min-height: 50vh;
    }

  #completeness_details tr{
      border-top: 1px dotted lightgray
  }

  .labell{
      text-align: left;
      font-weight: bold !important;
      padding: 0px;
  }
  .modal-header{
      background: #006f95 none repeat scroll 0 0;
      padding: 12px;
  }
  #completeness_details td{
      padding: 8px;
      border: 1px dotted ghostwhite;
  }
  #completeness_details .labell{
  }
  #mother_id_number, #father_id_number, #informant_id_number{
      text-transform: uppercase;
  }

  .sentence-case{
      text-transform: capitalize;
  }

 .edit{
    text-decoration: underline;
     cursor: pointer;
 }

</style>
<script src="/js/jquery.form-validator.min.js"></script>

  <form enctype="multipart/form-data" id="form-create-person" accept-charset="UTF-8"
        action="/save_record" method="POST"><input type="hidden" >

    <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>
    <%= hidden_field_tag :person_id, @person.person_id -%>

  <div id="progress-div" style="height: 3px;background: #003366;width: 2%;">&nbsp;</div>

  <fieldset id="child">
      <legend>DETAILS OF CHILD</legend>
      <div data-row-span="2" class="row">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Surname:</label>
          <input id="last_name" class="sentence-case" type="text" list="surname_list" autocomplete="off"
                 value="<%=@person.last_name%>" name="last_name" data-validation="required length" data-validation-length="2-55">
          <datalist id="surname_list">
            <%@last_names.each do |name|%>
                <option value="<%=name%>">
            <% end %>
          </datalist>

        </div>
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>First Name:</label>
          <input id="first_name" type="text"  class="sentence-case" list="first_name_list" autocomplete="off"
                 value="<%=@person.first_name%>" name="first_name" data-validation="required length" data-validation-length="2-55">
          <datalist id="first_name_list">
            <%@first_names.each do |name|%>
                <option value="<%=name%>">
            <% end %>
          </datalist>

        </div>
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Other Names:</label>
          <input id="middle_name"  class="sentence-case" type="text" name="middle_name" value="<%=@person.middle_name%>" list="middle_name_list"  autocomplete="off">
          <datalist id="middle_name_list">
            <%@middle_names.each do |name|%>
                <option value="<%=name%>">
            <% end %>
          </datalist>
        </div>
      </div>

      <div data-row-span="2" class="row">

        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Date of Birth:</label>
          <input id="date_of_birth" type="text" name="date_of_birth" value="<%=@person.date_of_birth.to_date.strftime("%d/%m/%Y") rescue nil%>"
                 class="datepicker" data-validation="required" data-validation-require-leading-zero="false" data-validation-format="dd/mm/yyyy">
        </div>

        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Sex:</label>
          <div>
            <select id="gender" name="gender" data-validation="required">
              <option></option>
              <option>Male</option>
              <option>Female</option>
            </select>
          </div>
        </div>
      </div>

      <div data-row-span="2" class="row" style="margin-bottom: 0px;">
        <label style="color: gray;text-decoration: underline;">Place of Birth</label>
      </div>

      <div data-row-span="2" class="row " style="margin-bottom: 35px;">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>District:</label>
          <select id="birth_district" type="text" name="birth_district" data-validation="required"
          onchange="tas('birth_ta', this.value, ['birth_village'])"></select>
        </div>
        <div data-field-span="1"  class="form-inline col-lg-3">
          <label>TA:</label>
          <select id="birth_ta" type="text" name="birth_ta" data-validation="required"
          onchange="villages('birth_village', document.getElementById('birth_district').value, document.getElementById('birth_ta').value)"> </select>
        </div>
        <div data-field-span="1"  class="form-inline col-lg-3">
          <label>Village:</label>
          <select id="birth_village" type="text" name="birth_village" data-validation="required"></select>
        </div>
      </div>

      <div data-row-span="2" class="row" style="border-top: 1px dotted ghostwhite;padding-top: 5px;">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Parents married to each other?:</label>
          <select id="married" name="parents_married" data-validation="required" onchange="checkMarriage()">
            <option></option>
            <option>Yes</option>
            <option>No</option>
          </select>
        </div>

        <div data-field-span="1" class="form-inline col-lg-3">
          <label>If yes, date of marriage:</label>
          <input type="text" name="date_of_marriage" id="date_of_marriage" disabled="disabled"
                 class="datepicker"  data-validation-require-leading-zero="false" data-validation-format="dd/mm/yyyy" >
        </div>
      </div>

    </fieldset>


    <fieldset id="mother" style="display: none">
      <legend>DETAILS OF MOTHER</legend>
      <div data-row-span="2" class="row">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Surname:</label>
          <input id="mother_last_name"  class="sentence-case" type="text" name="mother_last_name"  autocomplete="off" list="surname_list"
                 data-validation="required length" data-validation-length="2-30" value="<%=@person.mother_last_name%>">

        </div>
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>First Name:</label>
          <input id="mother_first_name"  class="sentence-case" type="text" name="mother_first_name" autocomplete="off" list="first_name_list"
                 data-validation="required length" data-validation-length="2-30" value="<%=@person.mother_first_name%>">
        </div>
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Other Names:</label>
          <input id="mother_middle_name"  class="sentence-case" type="text" name="mother_middle_name" autocomplete="off" list="middle_name_list"
                 value="<%=@person.mother_middle_name%>">
        </div>
      </div>

      <div data-row-span="2" class="row">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Nationality:</label>
          <select id="mother_nationality" name="mother_nationality" data-validation="required"
                  onchange = "nullify('mother_id_number', this)"
                  value="<%=@person.mother_nationality%>">
            <option></option>
          </select>
        </div>
        <div data-field-span="1" class="form-inline col-lg-3">
          <label >ID Number:</label>
          <input value="<%=@person.mother_id_number%>" id="mother_id_number" type="text" name="mother_id_number"
                 data-validation="mother_id_length mother_id_special_char father_mother_id_check" maxlength="8" size="8"
                 data-validation-ignore="o,i,-,!,$,%,^,&,*,(,),_,+,|,~,=,`,{,},\,[,\,],:,;,@,\,#,<,>,?,.,\,/,],|," >
        </div>
      </div>

    </fieldset>

    <fieldset id="father" style="display: none">
      <legend>DETAILS OF FATHER</legend>
      <div data-row-span="2" class="row">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Surname:</label>
          <input type="text"  class="sentence-case" name="father_last_name"  autocomplete="off" list="surname_list"
                 data-validation="father" id="father_last_name" value="<%=@person.father_last_name%>">
        </div>
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>First Name:</label>
          <input type="text" name="father_first_name" id="father_first_name"  class="sentence-case"  autocomplete="off" list="first_name_list"
                 data-validation="father" value="<%=@person.father_first_name%>">
        </div>
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Other Names:</label>
          <input type="text" name="father_middle_name" id="father_middle_name"  class="sentence-case"  autocomplete="off" list="middle_name_list"
                 value="<%=@person.father_middle_name%>">
        </div>
      </div>

      <div data-row-span="2" class="row">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Nationality:</label>
          <select id="father_nationality" name="father_nationality"  data-validation="father" value="<%=@person.father_nationality%>"
                  onchange = "nullify('father_id_number', this)">
            <option></option>
          </select>
        </div>
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>ID Number:</label>
          <input value="<%=@person.father_id_number%>" id="father_id_number" type="text" maxlength="8" size="8"
                 name="father_id_number"
                 data-validation="father_id_length father_id_special_char father_mother_id_check"
                 data-validation-ignore="o,i,-,!,$,%,^,&,*,(,),_,+,|,~,=,`,{,},\,[,\,],:,;,@,\,#,<,>,?,.,\,/,],|,">
        </div>
      </div>

    </fieldset>

    <fieldset id="informant" style="display: none">
      <legend>INFORMANTS DETAILS</legend>

      <div data-row-span="2" class="row">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Informant Relationship to Child:</label>
          <select id="informant_relationship" name="informant_relationship"
                  onchange="checkRelationship()"
                  data-validation="required" value="<%=@person.informant_relationship%>">
            <option></option>
            <option>Mother</option>
            <option>Father</option>
            <option>Grandmother/Grandfather</option>
            <option>Brother/Sister</option>
            <option>Aunt/Uncle</option>
            <option>Mother-in-law/Father-in-law</option>
            <option>Sister-in-marriage/Brother-in-marriage</option>
            <option>Other</option>
          </select>
        </div>

        <div data-field-span="1" class="form-inline col-lg-3">
          <label>ID Number:</label>
          <input value="<%=@person.informant_id_number%>" id="informant_id_number" type="text" name="informant_id_number" maxlength="8" size="8"
                 data-validation="informant_id_length informant_id_special_char"
                 data-validation-ignore="o,i,-,!,$,%,^,&,*,(,),_,+,|,~,=,`,{,},\,[,\,],:,;,@,\,#,<,>,?,.,\,/,],|," >
        </div>
      </div>

      <div data-row-span="2" class="row">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Surname:</label>
          <input type="text"  class="sentence-case" id="informant_last_name" name="informant_last_name"  autocomplete="off" list="surname_list"
                 value="<%=@person.informant_last_name%>" data-validation="required length" data-validation-length="2-30">
        </div>
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>First Name:</label>
          <input type="text"  class="sentence-case" id="informant_first_name" name="informant_first_name"  autocomplete="off" list="first_name_list"
                 value="<%=@person.informant_first_name%>" data-validation="required length" data-validation-length="2-30">
        </div>
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Other Names:</label>
          <input type="text"  class="sentence-case" id="informant_middle_name" name="informant_middle_name"  autocomplete="off" list="middle_name_list"
                 value="<%=@person.informant_middle_name%>">
        </div>
      </div>

      <div data-row-span="2" class="row" style="margin-bottom: 0px;border-top: 1px dotted gray;">
        <label style="color: gray;text-decoration: underline;">Informant Residential Address </label>
      </div>

      <div data-row-span="2" class="row " style="margin-bottom: 35px;">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>District:</label>
          <select id="informant_district" type="text" name="informant_district" data-validation="required"
                  onchange="tas('informant_ta', this.value, ['informant_village'])"></select>
        </div>
        <div data-field-span="1"  class="form-inline col-lg-3">
          <label>TA:</label>
          <select id="informant_ta" type="text" name="informant_ta" data-validation="required"
                  onchange="villages('informant_village', document.getElementById('informant_district').value, document.getElementById('informant_ta').value)"> </select>
        </div>
        <div data-field-span="1"  class="form-inline col-lg-3">
          <label>Village:</label>
          <select id="informant_village" data-validation="required" type="text" name="informant_village"></select>
        </div>
      </div>

      <div data-row-span="1" class="row">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Postal Address:</label>
          <input type="text"  class="sentence-case" name="informant_address_line1" placeholder="e.g CodeBuild Systems" value="<%=@person.informant_address_line1%>">
        </div>

        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Telephone Number:</label>
          <input type="text" name="informant_phone_number" placeholder="e.g 0991763413" onchange="removeSpace(this)"
                 data-validation="phone_number" data-validation-message="Input a valid phone number"
                 value="<%=@person.informant_phone_number%>">
        </div>
      </div>

      <div data-row-span="1" class="row">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label style="color: white;">Postal Address:</label>
          <input type="text"  class="sentence-case" name="informant_address_line2" placeholder="e.g P.O Box 31777" value="<%=@person.informant_address_line2%>">
        </div>

        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Form Signed?:</label>
          <select id="form_signed" name="form_signed" data-validation="required" value="<%=@person.form_signed%>">
            <option></option>
            <option>Yes</option>
            <option>No</option>
          </select>
        </div>
      </div>

      <div data-row-span="1" class="row">
        <div data-field-span="1" class="form-inline col-lg-3">
          <label style="color: white;">Postal Address:</label>
          <input type="text" class="sentence-case"  name="informant_address_line3" placeholder="e.g Balaka" value="<%=@person.informant_address_line3%>">
        </div>

        <div data-field-span="1" class="form-inline col-lg-3">
          <label>Date of Reporting:</label>
          <input id="date_reported" type="text" class="datepicker" name="date_reported"
                 data-validation="required" value="<%=@person.date_reported.to_date.strftime("%d/%m/%Y") rescue nil%>">
        </div>
      </div>


    </fieldset>

  <fieldset id="headman" style="display: none">
    <legend>DETAILS OF VILLAGE HEADMAN</legend>
    <div data-row-span="2" class="row" >

      <div data-field-span="1" class="form-inline col-lg-3">
        <label>TA Name:</label>
        <select id="ta_name" type="text" name="ta_name"  class="sentence-case"
               data-validation="length" data-validation-length="2-50" value="<%=@cur_location['ta']%>">
        </select>
      </div>

      <div data-field-span="1" class="form-inline col-lg-3">
        <label>Village Name:</label>
        <select id="village_name" type="text" name="village_name"  class="sentence-case"
               data-validation="length" data-validation-length="2-50" value="<%=@cur_location['village']%>">
        </select>
      </div>

    </div>

    <div data-row-span="2" class="row">
      <div data-field-span="1" class="form-inline col-lg-3">
        <label>Name of Village Headman:</label>
        <input id="village_headman_name" type="text"  class="sentence-case"
               name="village_headman_name" value="<%=@person.village_headman_name%>"
               data-validation="required length" data-validation-length="2-50" value="<%=@person.mother_last_name%>">
      </div>

      <div data-field-span="1" class="form-inline col-lg-3">
        <label>Village Headman Signed?:</label>
        <select id="village_headman_signed" name="village_headman_signed" data-validation="required" value="<%=@person.village_headman_signed%>">
          <option></option>
          <option>Yes</option>
          <option>No</option>
        </select>
      </div>

    </div>

  </fieldset>

    <div class="form-group actions-row" style="width: 100%;padding-right: 45%;">
      <button style="display: none" id="finish-btn" type="button" onclick="validateForm()" class="btn btn-primary"><span class="glyphicon glyphicon-save"></span> Finish </button>
      <% if false %>
        <button type="button" onclick="clearForm()" class="btn btn-warning" ><span></span> Clear </button>
      <% end %>

      <div type="next submit"  id="next-btn" style="font-weight: bold;" class="btn btn-next btn-success" onclick="next()" ><span></span> Next >> </div>
      <div type="back submit"  style="font-weight: bold;" class="btn btn-next btn-success" onclick="back()"><span></span> << Back </div>
      <button type="button" class="btn btn-danger" style="margin-left: 10px;" onclick="window.location = '/person/index?active_tab=person'; " ><b>Cancel</b></button>

    </div>



  <div class="modal fade" id="completenessModal" tabindex="-1" role="dialog" aria-labelledby="completenessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="printerModalLabel" style="text-align: left; color: white; font-weight: bold; text-align: center;">
            Check Completeness
          </h4>
        </div>
        <div class="modal-body">
        <span style="text-align:center;">
          <table align="center" id="completeness_details">

            <tr>
              <td class="labell">Child Name</td>
              <td style="text-align: left; padding-left:50px;" id="child_name" class="edit 0"></td>
            </tr>
            <tr>
              <td class="labell">Child Gender</td>
              <td style="text-align: left; padding-left:50px;" id="child_gender" class="edit 0">&nbsp;</td>
            </tr>
            <tr>
              <td class="labell">Child Date of Birth</td>
              <td style="text-align: left; padding-left:50px;" id="child_date_of_birth" class="edit 0">&nbsp;</td>
            </tr>
            <tr>
              <td class="labell">Child Place of Birth</td>
              <td style="text-align: left; padding-left:50px;" id="child_place_of_birth" class="edit 0">&nbsp;</td>
            </tr>
            <tr>
              <td class="labell">Mother Name</td>
              <td style="text-align: left; padding-left:50px;" id="mother_name" class="edit 1">&nbsp;</td>
            </tr>
            <tr>
              <td class="labell">Nationality of Mother</td>
              <td style="text-align: left; padding-left:50px;" id="mother_nationality" class="edit 1">&nbsp;</td>
            </tr>
            <tr>
              <td class="labell">Mother National ID</td>
              <td style="text-align: left; padding-left:50px;" id="mother_id_number" class="edit 1">&nbsp;</td>
            </tr>
            <tr>
              <td class="labell">Father Name</td>
              <td style="text-align: left; padding-left:50px;" id="father_name" class="edit 2">&nbsp;</td>
            </tr>
            <tr>
              <td class="labell">Nationality of Father</td>
              <td style="text-align: left; padding-left:50px;" id="father_nationality" class="edit 2">&nbsp;</td>
            </tr>
            <tr>
              <td class="labell">Father National ID</td>
              <td style="text-align: left; padding-left:50px;" id="father_id_number" class="edit 2">&nbsp;</td>
            </tr>
            <tr>
              <td class="labell">Parents Married to each Other?</td>
              <td style="text-align: left; padding-left:50px;" id="parents_married" class="edit 0">&nbsp;</td>
            </tr>
            <tr>
              <td class="labell">Parents signed?</td>
              <td style="text-align: left; padding-left:50px;" id="form_signed" class="edit 3">&nbsp;</td>
            </tr>

          </table>
        </span>

          <div class="modal-footer">
            <button type="button submit" class="btn btn-primary" ><b>Save Record</b></button>
            <button type="button" class="btn btn-warning" data-dismiss="modal"><b>Keep Editing</b></button>

          </div>

        </div>
      </div>
    </div>
  </div>


  </form>

<script src="/Pikaday/moment.js"></script>
<script src="/Pikaday/pikaday.js"></script>

<script>
    function __$(id){
        return document.getElementById(id);
    }

    var sets = document.getElementsByTagName("fieldset");
    var cur_pos = 0;

    $.formUtils.addValidator({
        name : 'father',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if ((__$("father_first_name").value.trim().length > 0 ||
                    __$("father_last_name").value.trim().length > 0 ||
                    __$("father_middle_name").value.trim().length > 0 ||
                    __$("father_nationality").value.trim().length > 0 ||
                    __$("father_id_number").value.trim().length > 0)){

                validate = true;
            }else{
                validate = false
            }

            if (validate && value.trim().length == 0){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'Field is required',
        errorMessageKey: 'FatherNotComplete'
    });

    $.formUtils.addValidator({
        name : 'phone_number',
        validatorFunction : function(value, $el, config, language, $form) {

            if (value.trim().length > 0 && !value.trim().match("^0\\d{7}$|^0\\d{9}$")){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'Input a valid phone number',
        errorMessageKey: 'InvalidPhoneNumber'
    });

    $.formUtils.addValidator({
        name : 'father_mother_id_check',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if (__$("father_nationality").value.trim() == "Malawian" && (__$("father_first_name").value.trim().length > 0 ||
                    __$("father_last_name").value.trim().length > 0 ||
                    __$("father_middle_name").value.trim().length > 0 ||
                    __$("father_id_number").value.trim().length > 0) && __$("father_id_number").value.trim() != ""){

                validate = true;
            }else{
                validate = false;
                __$("father_id_number").value = "";
            }

            if(__$("father_id_number").value.trim().length > 0 && __$("mother_id_number").value.toUpperCase().trim() == __$("father_id_number").value.toUpperCase().trim()){
                return false;
            }else{
                return true;
            }
        },
        errorMessage : 'Mother ID Number cannot be the same as father ID Number',
        errorMessageKey: 'MotherFatherIdSimilar'
    });


    $.formUtils.addValidator({
        name : 'father_id',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if (__$("father_nationality").value.trim() == "Malawian" && (__$("father_first_name").value.trim().length > 0 ||
                    __$("father_last_name").value.trim().length > 0 ||
                    __$("father_middle_name").value.trim().length > 0 ||
                    __$("father_id_number").value.trim().length > 0) && __$("father_id_number").value.trim() != ""){

                validate = true;
            }else{
                validate = false;
                __$("father_id_number").value = "";
            }

            if (validate && ((__$("father_id_number").value.trim().length != 8) ||
                    (__$("father_id_number").value.trim().match(/\i|o|I|O/g)))){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'ID Number must have length of 8; does not contain letter I (use number 1 instead), does not have letter O (use number 0 instead); should be different from mother ID Number',
        errorMessageKey: 'IDNotComplete'
    });

    $.formUtils.addValidator({
        name : 'father_id_length',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if (__$("father_nationality").value.trim() == "Malawian" && (__$("father_first_name").value.trim().length > 0 ||
                    __$("father_last_name").value.trim().length > 0 ||
                    __$("father_middle_name").value.trim().length > 0 ||
                    __$("father_id_number").value.trim().length > 0) && __$("father_id_number").value.trim() != ""){

                validate = true;
            }else{
                validate = false;
                __$("father_id_number").value = "";
            }

            if (validate && (__$("father_id_number").value.trim().length != 8)){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'ID Number must have length of 8',
        errorMessageKey: 'IDNotBadLength'
    });

    $.formUtils.addValidator({
        name : 'father_id_special_char',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if (__$("father_nationality").value.trim() == "Malawian" && (__$("father_first_name").value.trim().length > 0 ||
                    __$("father_last_name").value.trim().length > 0 ||
                    __$("father_middle_name").value.trim().length > 0 ||
                    __$("father_id_number").value.trim().length > 0) && __$("father_id_number").value.trim() != ""){

                validate = true;
            }else{
                validate = false;
                __$("father_id_number").value = "";
            }

            if (validate && ((__$("father_id_number").value.trim().length > 0) &&
                    (__$("father_id_number").value.trim().match(/\i|o|I|O/g)))){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'ID Number does not contain letter I (use number 1 instead), does not have letter O (use number 0 instead)',
        errorMessageKey: 'IDSpecialChar'
    });


    $.formUtils.addValidator({
        name : 'mother_id',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if (__$("mother_nationality").value.trim() == "Malawian" && __$("mother_id_number").value.trim() != ""){
                validate = true;
            }else{
                validate = false;
                __$("mother_id_number").value = "";
            }

            if (validate && ((__$("mother_id_number").value.trim().length != 8) ||
                    (__$("mother_id_number").value.trim().match(/\i|o|I|O/g)))){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'ID Number must have length of 8; does not contain letter I (use number 1 instead), does not have letter O (use number 0) instead;  should be different from Father ID Number',
        errorMessageKey: 'IDNotComplete'
    });

    $.formUtils.addValidator({
        name : 'mother_id_special_char',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if (__$("mother_nationality").value.trim() == "Malawian" && __$("mother_id_number").value.trim() != ""){
                validate = true;
            }else{
                validate = false;
                __$("mother_id_number").value = "";
            }

            if (validate && (__$("mother_id_number").value.trim().match(/\i|o|I|O/g))){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'ID Number does not contain letter I (use number 1 instead), does not have letter O (use number 0) instead',
        errorMessageKey: 'MIDNotComplete'
    });

    $.formUtils.addValidator({
        name : 'mother_id_length',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if (__$("mother_nationality").value.trim() == "Malawian" && __$("mother_id_number").value.trim() != ""){
                validate = true;
            }else{
                validate = false;
                __$("mother_id_number").value = "";
            }

            if (validate && (__$("mother_id_number").value.trim().length != 8)){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'ID Number must have length of 8',
        errorMessageKey: 'MIDNotComplete'
    });

    $.formUtils.addValidator({
        name : 'informant_id',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if (__$("informant_id_number").value.trim() != ""){
                validate = true;
            }else{
                validate = false;
                __$("informant_id_number").value = "";
            }

            if (validate && ((__$("informant_id_number").value.trim().length != 8) ||
                    (__$("informant_id_number").value.trim().match(/\i|o|I|O/g)))){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'ID Number must have length of 8; does not contain letter I (use number 1 instead), does not have letter O (use number 0) instead',
        errorMessageKey: 'IDNotComplete'
    });

    $.formUtils.addValidator({
        name : 'informant_id_length',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if (__$("informant_id_number").value.trim() != ""){
                validate = true;
            }else{
                validate = false;
                __$("informant_id_number").value = "";
            }

            if (validate && (__$("informant_id_number").value.trim().length != 8)){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'ID Number must have length of 8',
        errorMessageKey: 'IDNotCompleteLength'
    });

    $.formUtils.addValidator({
        name : 'informant_id_special_char',
        validatorFunction : function(value, $el, config, language, $form) {
            var validate;
            var id = $el.attr("id");

            if (__$("informant_id_number").value.trim() != ""){
                validate = true;
            }else{
                validate = false;
                __$("informant_id_number").value = "";
            }

            if (validate && (__$("informant_id_number").value.trim().match(/\i|o|I|O/g))){
                return false;
            }else {
                return true;
            }
        },
        errorMessage : 'ID Number does not contain letter I (use number 1 instead), does not have letter O (use number 0) instead',
        errorMessageKey: 'IDNotComplete'
    });

    $.validate({
        validateOnBlur : true,
        showHelpOnFocus : true,
        addSuggestions : true,
        errorMessagePosition : 'top',
        scrollToTopOnError : false,
        onError : function(){
            alert("Could not validate some input elements");
        }
    });

    <% (["Malawian"] + @nationalities).uniq.each do |n|
    next if n.blank?
    %>
        var opt = document.createElement("option");
        opt.value = "<%=n%>";
        opt.innerHTML = "<%=n%>";
        __$("mother_nationality").appendChild(opt);
    <% end %>

    <% (["Malawian"] + @nationalities).uniq.each do |n|
    next if n.blank?
    %>
        var opt = document.createElement("option");
        opt.value = "<%=n%>";
        opt.innerHTML = "<%=n%>";
        __$("father_nationality").appendChild(opt);
    <% end %>

    function removeSpace(node){
        node.value = node.value.trim().replace(/\s+/g, "");
    }

    function next() {

        jQuery(sets[cur_pos]).find("input, select").validate();
        if (jQuery(sets[cur_pos]).find(".error").length > 0) {
            jQuery('#form-create-person').submit();
            jQuery("fieldset .form-error").hide();
        }else {
            jQuery('.form-error').hide();
            if (cur_pos < sets.length - 1) {
                for (var i = 0; i < sets.length; i++) {
                    sets[i].style.display = "none";
                }
                cur_pos += 1;
                sets[cur_pos].style.display = "block";
            }
        }

        if (cur_pos == sets.length - 1){
            //Show Finish Button And Hide Next Button
            jQuery("#next-btn").hide();
            jQuery("#finish-btn").show();
        }else{
            jQuery("#next-btn").show();
            jQuery("#finish-btn").hide();
        }
        __$("progress-div").style.width = (cur_pos/sets.length)*100 + "%";
    }

    function back(){
        if(cur_pos > 0){
            for(var i = 0; i < sets.length; i++){
                sets[i].style.display = "none";
            }
            cur_pos -= 1;
            sets[cur_pos].style.display = "block";
        }

        if (cur_pos == sets.length - 1){
            //Show Finish Button And Hide Next Button
            jQuery("#next-btn").hide();
            jQuery("#finish-btn").show();
        }else{
            jQuery("#next-btn").show();
            jQuery("#finish-btn").hide();
        }
    }

    function clearForm(){
        jQuery(sets[cur_pos]).find("input, select").val("");
        __$("progress-div").style.width = "0%";

    }

    function districts(id, dep){
        for(var i = 0; i < dep.length; i++){
            jQuery("#" + dep[i]).val("");
            jQuery(document.getElementById(dep[i])).empty();
        }

        var node = document.getElementById(id);
        jQuery(node).empty();

        jQuery.ajax({
            url: "/districts",
            success: function(results){

                var opts = JSON.parse(results);
                for(var i in opts){
                    var option = document.createElement("option");
                    option.innerHTML = opts[i];
                    option.setAttribute("value", opts[i]);

                    <% if request.path.match("/edit")%>
                        if('<%= @person.district_of_birth%>' == opts[i] && id=="birth_district") {
                            option.setAttribute("selected", "true");
                            tas('birth_ta', opts[i], ['birth_village'])
                        }

                        if('<%= @person.informant_district%>' == opts[i] && id=="informant_district") {
                            option.setAttribute("selected", "true");
                            tas('informant_ta', opts[i], ['informant_village'])
                        }
                    <% end %>
                    node.appendChild(option);
                }

            },
            error: function(){

            }
        })
    }

    function tas(id, parent, dep){
        for(var i = 0; i < dep.length; i++){
            jQuery("#" + dep[i]).val("");
            jQuery(document.getElementById(dep[i])).empty();
        }

        var node = document.getElementById(id);
        jQuery(node).empty();

        jQuery.ajax({
            url: ("/tas?parent=" + parent),
            success: function(results){

                var opts = JSON.parse(results);
                for(var i in opts){
                    var option = document.createElement("option");
                    option.innerHTML = opts[i];
                    option.setAttribute("value", opts[i]);
                    <% if request.path.match("/edit")%>

                        if('<%= @person.ta_of_birth%>' == opts[i] && id=="birth_ta") {
                            option.setAttribute("selected", "true");
                            villages('birth_village', __$('birth_district').value, opts[i]);
                        }

                        if('<%= @person.informant_ta%>' == opts[i] && id=="informant_ta") {
                            option.setAttribute("selected", "true");
                            villages('informant_village', __$('informant_district').value, opts[i]);
                        }
                    <% end %>
                    node.appendChild(option);
                }

            },
            error: function(){

            }
        })
    }

    function checkMarriage(){
        if (__$("married").value.trim() == "Yes"){
            __$("date_of_marriage").removeAttribute("disabled");
            //__$("date_of_marriage").setAttribute("data-validation", "required");
            __$("date_of_marriage").setAttribute("data-validation-format", "dd/mm/yyyy")

        }else{
            //__$("date_of_marriage").removeAttribute("data-validation");
            __$("date_of_marriage").removeAttribute("data-validation-format");
            __$("date_of_marriage").setAttribute("disabled", "disabled");
            __$("date_of_marriage").value = "";
        }
    }

    function villages(id, district, ta){

        var node = document.getElementById(id);
        jQuery(node).empty();

        jQuery.ajax({
            url: ("/villages?district=" + district + "&ta=" + ta),
            success: function(results){

                var opts = JSON.parse(results);

                for(var i in opts){
                    var option = document.createElement("option");
                    option.innerHTML = opts[i];
                    option.setAttribute("value", opts[i]);

                    <% if request.path.match("/edit")%>
                        if('<%= @person.village_of_birth%>' == opts[i] && id=="birth_village") {
                            option.setAttribute("selected", "true");
                        }

                        if('<%= @person.informant_village%>' == opts[i] && id=="informant_village") {
                            option.setAttribute("selected", "true");
                        }
                    <% end %>
                    node.appendChild(option);
                }

            },
            error: function(){
            }
        })
    }

    function validateForm(){

        var hash = jQuery("#form-create-person").serializeHash();
        for(var k in hash){
            if (hash[k] == null){
                hash[k] = "";
            }
        }

        $("#completeness_details #child_name").html(hash['first_name'] + " " + hash['middle_name'] + " " + hash["last_name"]);
        $("#completeness_details #child_gender").html(hash['gender']);
        $("#completeness_details #child_date_of_birth").html(hash['date_of_birth']);
        $("#completeness_details #child_place_of_birth").html(hash['birth_village'] + ", " + hash["birth_ta"] + ", " + hash["birth_district"]);

        $("#completeness_details #mother_name").html(hash['mother_first_name'] + " " + hash['mother_middle_name'] + " " + hash["mother_last_name"]);
        $("#completeness_details #father_name").html(hash['father_first_name'] + " " + hash['father_middle_name'] + " " + hash["father_last_name"]);

        $("#completeness_details #mother_nationality").html(hash['mother_nationality']);
        $("#completeness_details #father_nationality").html(hash['father_nationality']);

        $("#completeness_details #mother_id_number").html(hash['mother_id_number']);
        $("#completeness_details #father_id_number").html(hash['father_id_number']);

        $("#completeness_details #parents_married").html(hash['parents_married']);
        $("#completeness_details #form_signed").html(hash['form_signed']);

        var nodes = document.getElementsByClassName("edit");
        for(var i = 0; i < nodes.length; i++){
            var section = parseInt(nodes[i].className.split(/\s/)[1].trim());
            nodes[i].setAttribute("section", section);
            nodes[i].onmousedown = function() {
                moveToSection(parseInt(this.getAttribute("section")));
             }
        }

        jQuery('#completenessModal').modal('show');
    }

    jQuery('#form-create-person').submit(function(e){
        e.preventDefault();
        jQuery.ajax(
                {
                    url: "/save_record",
                    type: "POST",
                    data: $("#form-create-person").serialize(),
                    success: function(response){
                        if (response == "OK") {
                            window.location = "/person/index?active_tab=home";
                        }else{
                            alert("something Went Wrong!!")
                        }
                    },
                    error: function(){
                        alert("Something Went Wrong!!");
                    }
                }
        )
    })

    function moveToSection(section){
        console.log(section);
        cur_pos = section;
        jQuery('.form-error').hide();
        for (var i = 0; i < sets.length; i++) {
            sets[i].style.display = "none";
        }
        sets[section].style.display = "block";
        jQuery("#next-btn").show();
        jQuery("#back-btn").show();

        jQuery('#completenessModal').modal('hide');
    }

    function copyMother(){
        __$("informant_first_name").value =  __$("mother_first_name").value;
        __$("informant_last_name").value =  __$("mother_last_name").value;
        __$("informant_middle_name").value =  __$("mother_middle_name").value;
        __$("informant_id_number").value =  __$("mother_id_number").value;
    }

    function copyFather(){
        __$("informant_first_name").value =  __$("father_first_name").value;
        __$("informant_last_name").value =  __$("father_last_name").value;
        __$("informant_middle_name").value =  __$("father_middle_name").value;
        __$("informant_id_number").value =  __$("father_id_number").value;
    }

    function lockFields(lockableFields){
        for(var i = 0; i < lockableFields.length; i++){
            __$(lockableFields[i]).setAttribute("disabled", "disabled");
        }
    }

    function unlockFields(unlockableFields){
        for(var i = 0; i < unlockableFields.length; i++){
            __$(unlockableFields[i]).value = ""
            __$(unlockableFields[i]).removeAttribute("disabled");
        }
    }

    function checkRelationship(){
        if (__$("informant_relationship").value == "Mother"){
            copyMother(); lockFields(["informant_first_name", "informant_last_name", "informant_middle_name", "informant_id_number"])
        }else if(__$("informant_relationship").value == "Father") {
            copyFather(); lockFields(["informant_first_name", "informant_last_name", "informant_middle_name", "informant_id_number"])
        }else{
            unlockFields(["informant_first_name", "informant_last_name", "informant_middle_name", "informant_id_number"]);
        }
    }

    function nullify(id, field){
        if (field.value.trim() != "Malawian"){
            __$(id).value = "";
        }
    }

    districts("birth_district", ['birth_ta', 'birth_village']);
    districts("informant_district", ['informant_ta', 'informant_village']);

   <% if request.path.match("/edit")
   %>

    __$("gender").value = "<%= @person.gender%>";
    __$("married").value = "<%= @person.parents_married%>";
    __$("mother_nationality").value = "<%= @person.mother_nationality%>";
    __$("father_nationality").value = "<%= @person.father_nationality%>";
    __$("informant_relationship").value = "<%= @person.informant_relationship%>";
    __$("informant_district").value = "<%= @person.informant_district%>";
    __$("form_signed").value = "<%= @person.form_signed%>";
    __$("date_of_marriage").value = "<%= @person.date_of_marriage%>";
    __$("village_headman_signed").value = "<%= @person.village_headman_signed%>";
    <% else %>

   <% end %>


    var dobpicker;
    var dompicker;
    var dompicker;

    jQuery(document).ready(function(){
        var d = new Date();
        d.setFullYear(d.getFullYear() - 16);

        var d2 = new Date();
        d2.setFullYear(d.getFullYear() - 50);

        dobpicker = new Pikaday({
            field: document.getElementById('date_of_birth'),
            format: 'DD/MMM/YYYY',
            minDate: d,
            maxDate: new Date()
        } );

        dompicker = new Pikaday({
            field: document.getElementById('date_of_marriage'),
            format: 'DD/MMM/YYYY',
            minDate: d2,
            maxDate: new Date()
        });

        dompicker = new Pikaday({
            field: document.getElementById('date_reported'),
            format: 'DD/MMM/YYYY',
            minDate: (new Date("01/Sep/2018")),
            maxDate: new Date()
        });

        tas('ta_name', "<%=@cur_location['district']%>", [])
        villages('village_name', "<%=@cur_location['district']%>", "<%=@cur_location['ta']%>");

        setTimeout(function(){
            <% if !request.path.match("/edit")%>
            __$("ta_name").value = "<%= @cur_location['ta']%>";
            __$("village_name").value = "<%= @cur_location['village']%>";
            <% else %>
            __$("ta_name").value = "<%= @person.ta_created_at%>";
            __$("village_name").value = "<%= @person.location_created_at%>";
            <% end %>
        }, 1000)

    })

    $("select option").css("background-color","red");
</script>
